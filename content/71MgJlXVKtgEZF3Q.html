<!DOCTYPE html>
<html>
<head>
<title>uniCloud云数据库聚合操作之列表与详情数据查询 - 王维的博客</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<link href="../highlight/styles/a11y-dark.min.css" rel="stylesheet">
<script src="../highlight/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>
<style type="text/css">
    body {
        margin-top: 70px;
    }
    h1 {
        font-size: 18px;
    }
    h3 {
        font-size: 16px;
    }
    p {
        font-size: 14px;
    }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">王维的博客</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="../index.html">主页</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/php.html">PHP</a></li>
                    <li class="nav-item active"><a class="nav-link" href="../html/vue.html">Vue</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/unicloud.html">uniCloud</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/notes.html">随手笔记</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="content mt-3">
            <h1>uniCloud云数据库聚合操作之列表与详情数据查询</h1>
            <span class="date"><small>2022-03-11</small></span>
            <div class="mt-4">
                <p>本文记录在使用uniCloud云开发时，云数据库查询数据的基本代码，包括列表查询和单条数据详情查询。</p>
                <p>uniapp的uniCloud云开发数据库查询跟Mysql查询不一样，它用的是MongoDB语法，如果不懂MongoDB语法或没用过使用起来将会非常难以入手。</p>
                <p>本例代码基于uniCloud云开发，使用了官方提供的opendb-mall商城相关的数据库表，如果是自建表只需要修改代码中的表名和字段即可。</p>
                <p>本文假定本地开发环境都已部署好（正常关联了腾讯或阿里云服务空间）。</p>
                <h3>一、创建数据表</h3>
                <p>在uniCloud Web控制台先创建好相关的表opendb-mall-goods和opendb-mall-sku，本例只用到了此二张表</p>
                <h3>二、编写云函数</h3>
<pre><code class="javascript">// 商品类云函数
'use strict';
const db = uniCloud.database()
exports.main = async (events, context) => {
    switch (events.action) {
        case 'list':    // 查询商品列表
            return new Promise((resolve, reject) => {
                db.collection('opendb-mall-goods').aggregate().lookup({
                    from: 'opendb-mall-sku',
                    localField: '_id',
                    foreignField: 'goods_id',
                    as: 'skuList'
                }).end().then(res => {
                    resolve(res)
                }).catch(err => {
                    reject(err)
                })
            })
            break
        case 'info':    // 查询商品详情
            return new Promise((resolve, reject) => {
                db.collection('opendb-mall-goods').aggregate().lookup({
                    from: 'opendb-mall-sku',
                    localField: '_id',
                    foreignField: 'goods_id',
                    as: 'skuList'
                }).match({
                    _id: events.id
                }).end().then(res => {
                    resolve(res)
                }).catch(err => {
                    reject(err)
                })
            })
            break
    }
}</code></pre>
                <p>以上列表和详情的代码区别只是详情多了一个match()方法，返回数据分别如下</p>
<pre><code class="javascript">// 列表
data: [{
    _id: "41ae62ef62161045087a14de5e9d8038",
    total_sell_count: "0",
    comment_count: "0",
    goods_sn: "001",
    is_alone_sale: true,
    is_best: false,
    is_hot: true,
    is_new: true,
    is_on_sale: true,
    is_real: true,
    month_sell_count: "0",
    name: "测试商品名称",
    remain_count: "0",
    skuList: [
        {_id: "54ad1eea621610dc1278dc9809d927b0", goods_id: "41ae62ef62161045087a14de5e9d8038", price: "0.01",…},
        {_id: "617ef50c6221b6f909aea6d2395ce928", goods_id: "41ae62ef62161045087a14de5e9d8038", price: "0.02",…},
        {_id: "bf4a0bf26221bec212b32e39651e8b8f", goods_id: "41ae62ef62161045087a14de5e9d8038", price: "0.02",…}
    ]
},
{_id: "41ae62ef622b0f850baf305d3bd85b84", is_new: true, is_on_sale: true, is_real: true,…}]
// 详情
data: {
    {
        _id: "41ae62ef62161045087a14de5e9d8038",
        total_sell_count: "0",
        comment_count: "0",
        goods_sn: "001",
        is_alone_sale: true,
        is_best: false,
        is_hot: true,
        is_new: true,
        is_on_sale: true,
        is_real: true,
        month_sell_count: "0",
        name: "测试商品名称",
        remain_count: "0"
        skuList: {
            {_id: "54ad1eea621610dc1278dc9809d927b0", goods_id: "41ae62ef62161045087a14de5e9d8038", price: "0.01", sku_name: "白色", stock: 100, …},
            {_id: "617ef50c6221b6f909aea6d2395ce928", goods_id: "41ae62ef62161045087a14de5e9d8038", price: "0.02", sku_name: "黑色", stock: 200, …},
            {_id: "bf4a0bf26221bec212b32e39651e8b8f", goods_id: "41ae62ef62161045087a14de5e9d8038", price: "0.03", sku_name: "紫色", stock: 300, …}
        }
    }
}</code></pre>
                <h3>三、模板代码</h3>
<pre><code class="javascript">// 获取商品列表
uniCloud.callFunction({
    name: 'goods',
    data: {
        action: 'list'
    }
}).then(res => {
    res.result.data.forEach(item => {
        this.goodsList.push(item)
    })
})
// 获取商品详情
uniCloud.callFunction({
    name: 'goods',
    data: {
        action: 'info',
        id: '商品id'
    }
}).then(res => {
    console.log(res.result)
})</code></pre>
                <h3>四、说明</h3>
                <p>1、本地编写好的云函数需要右键上传部署才会生效</p>
                <p>2、免费云空间对函数个数有限制，本例中云函数用参数形式实现不同查询需求，可以有效减少云函数数量；</p>
                <p>3、unicloud-db前端组件看似虽好实则巨坑，文档写得模棱两可；联表查询不知道是写法不对还是什么原因无法实现上述查询需求，单条数据查询虽然没有问题，但诡异的是居然会影响到页面布局（可能我打开的方式不对？也可能前端组件本身有默认样式？）</p>
            </div>
        </div>
    </div>
    <footer class="footer mt-3 bg-dark">
        <div class="container pt-3 pb-3 text-light text-center">Copyright &copy;王维 2022 254555778@qq.com</div>
    </footer>
</body>
</html>