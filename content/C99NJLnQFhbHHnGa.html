<!DOCTYPE html>
<html>
<head>
<title>uniapp实现微信公众号网页支付 - 王维的博客</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="../favicon.ico" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<link href="../highlight/styles/a11y-dark.min.css" rel="stylesheet">
<script src="../highlight/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>
<style type="text/css">
    body {
        margin-top: 70px;
    }
    h1 {
        font-size: 18px;
    }
    h3 {
        font-size: 16px;
    }
    p {
        font-size: 14px;
    }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">王维的博客</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="../index.html">主页</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/php.html">PHP</a></li>
                    <li class="nav-item active"><a class="nav-link" href="../html/vue.html">Vue</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/unicloud.html">uniCloud</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/notes.html">随手笔记</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="content mt-3">
            <h1>uniapp实现微信公众号网页支付</h1>
            <span class="date"><small>2022-03-12</small></span>
            <div class="mt-4">
                <p>本文记录uniapp开发的手机网页版如何实现微信和支付宝支付。</p>
                <p>微信网页支付就是公众号支付，必须使用微信内置浏览器（当然微信官方有提供非微信浏览器的H5支付），本文实现的是在微信浏览器的公众号支付，微信中使用支付宝支付已有另一篇博文有详细解说，请参考<a href="5mYREEwRFrys7DJW.html">uniapp实现在微信H5中使用支付宝支付</a>。</p>
                <h3>一、微信公众号支付所需的配置</h3>
                <p>1、公众号后台设置网页授权域名（支付必须要获取openid）；</p>
                <p>2、商户后台配置支付授权目录、IP白名单和支付密钥，如果需要支持退款还需要生成api证书；</p>
                <p>3、支付业务所需四个参数，公众号app_id、开发者密钥secret、商户号mch_id和支付密钥key，四个缺一不可。</p>
                <h3>二、前端代码</h3>
                <p>向后端发送支付参数，并返回微信支付信息，下方$wechat.wxpay是封装好的JS模块，详见<a href="content/XShrTSmUyMdpSxfQ.html">uniapp封装微信h5支付、分享等功能</a>。</p>
<pre><code class="javascript">// /pages/payment/pay.vue
this.$http.post('/payment/pay', this.form).then(res => {
    let _this = this
    _this.$wechat.wxpay(res.data.paystring, function(ret) {
        switch (ret.errMsg) {
            case 'chooseWXPay:ok':
                uni.showModal({
                    content: '支付成功',
                    showCancel: false,
                    success: (ret) => {
                        uni.switchTab({
                            url: '/pages/order/order'
                        })
                    }
                })
                break
            case 'chooseWXPay:cancel':
                uni.showModal({
                    content: '已取消，您可以重新支付',
                    showCancel: false
                })
                break
            case 'chooseWXPay:fail':
                uni.showModal({
                    content: '支付失败',
                    showCancel: false
                })
                break
        }
    })
})</code></pre>
                <h3>三、后端代码</h3>
                <p>后端使用了EasyWechat4.3插件。</p>
<pre><code class="php">// payment/pay.php
use EasyWeChat\Factory;
use think\Config;
// ...
$app = Factory::payment(Config::get('wechat.h5pay'));
$pay = $app->order->unify([
    'body' => '订单支付',
    'attach' => $params['type'],
    'out_trade_no' => $out_trade_no,
    'total_fee' => $order['amount'] * 100,
    'notify_url' => 'https://api.xxx.com/wechat/notify',
    'trade_type' => 'JSAPI',
    'openid' => $params['openid']
]);
if (isset($params['url'])) {
    $app->jssdk->setUrl($params['url']);
}
$data['paystring'] = $app->jssdk->bridgeConfig($pay['prepay_id'], false);
$this->success('data',$data);</code></pre>
                <h3>四、支付结果通知</h3>
<pre><code class="php">// wechat/notify.php
use EasyWeChat\Factory;
use think\Config;
// ...
public function notify()
{
    $app = Factory::payment(Config::get('wechat.minipay'));
    $response = $app->handlePaidNotify(function($message, $fail) {
        $attach = $message['attach'];
        switch($attach) {
            case 'order':
                $order = $this->orderModel->where(['out_trade_no'=>$message['out_trade_no']])->find();
                if (!$order || $order['pay_status'] == '1') {
                    return true;
                }

                if ($message['return_code'] === 'SUCCESS') {
                    if ($message['result_code'] === 'SUCCESS') {
                        // 支付成功，更新订单支付状态
                    } elseif ($message['result_code'] === 'FAIL') {
                        // 支付失败
                    }
                } else {
                    return $fail('fail');
                }
                break;
        }
        return true;
    });
    $response->send();
}</code></pre>
                <h3>五、注意事项</h3>
                <p>1、提交支付前一定要先获取用户openid，snsapi_base或snsapi_userinfo授权都可以；</p>
                <p>2、前端的/pages/payment/是需要填写到商户后台的支付授权目录，完整格式是http://xxx.com/pages/payment/；</p>
                <p>3、支付结果一定要以微信服务器通知的结果为准，前端代码的“支付成功”状态并不可信！</p>
                <p>4、处理支付结果通知时，不管订单是否存在还是状态为已支付，或者业务逻辑处理完后，都需要向微信服务器返回true，否则微信会在一段时间内反复通知（支付宝也一样）。</p>
            </div>
        </div>
    </div>
    <footer class="footer mt-3 bg-dark">
        <div class="container pt-3 pb-3 text-light text-center">Copyright &copy;王维 2022 254555778@qq.com</div>
    </footer>
</body>
</html>