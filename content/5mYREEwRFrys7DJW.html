<!DOCTYPE html>
<html>
<head>
<title>uniapp实现在微信H5中使用支付宝支付 - 王维的博客</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<link href="../highlight/styles/a11y-dark.min.css" rel="stylesheet">
<script src="../highlight/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>
<style type="text/css">
    body {
        margin-top: 70px;
    }
    h1 {
        font-size: 18px;
    }
    h3 {
        font-size: 16px;
    }
    p {
        font-size: 14px;
    }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">王维的博客</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="../index.html">主页</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/php.html">PHP</a></li>
                    <li class="nav-item active"><a class="nav-link" href="../html/vue.html">Vue</a></li> 
                    <li class="nav-item"><a class="nav-link" href="../html/notes.html">随手笔记</a></li> 
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="content mt-3">
            <h1>uniapp实现在微信H5中使用支付宝支付</h1>
            <span class="date"><small>2022-01-11</small></span>
            <div class="mt-4">
                <p>本文解决的是使用uniapp开发的在微信公众号内实现支付宝支付的方法，其他端如小程序、APP不适用。</p>
                <h3>本文要实现的功能及流程</h3>
                <p>1、用户提交订单后，跳转到/pages/payment/pay.vue订单支付页；</p>
                <p>2、订单支付页有微信支付、支付宝支付两个选项；</p>
                <p>3、选择支付宝方式后，点击确定按钮向后台请求支付信息；</p>
                <p>4、获取到后台返回的支付信息后，跳转到/pages/payment/alipay.vue，提示用户在浏览器中打开支付（即下图1）；</p>
                <p>5、用户按提示使用浏览器打开后，会自动进入支付宝网页版进行支付，如果安装有支付宝客户端，会提示是否打开支付宝app或继续使用网页版进行支付。</p>
                <p>实现效果图：</p>
                <p>
                <img style="max-width: 100%;" src="https://files.xiaozhijia.com/assets/img/alipay_demo.png">
                </p>
                <p>以上是支付宝官方提供的一个在微信H5中使用支付宝支付的插件，<a href="https://gw.alipayobjects.com/os/bmw-prod/aefe726f-6363-4bfb-9141-4e4bb75d56fb.zip" target="_blank">点击下载</a>，先下载好解压备用。</p>
                <p>以上方式在非前后端分离的项目中非常好实现，照着Demo基本都能成功，接下来要做的是，如何在用uniapp开发的网页项目中实现。</p>
                <p>本文假定你的项目后端接口正常，能正常返回支付宝支付串，我用的是支付宝官方EasySDK，alipayFactory::payment()->wap()->optional()方法返回的支付串（实际是带支付参数的form表单数据）。</p>
                <h3>第一步，下载的压缩包解压后，需要用到里面的ap.js和pay.htm两个文件</h3>
                <p>1、先复制ap.js到/common/目录中，放其他目录也可以，但一定要保证接下来2处的引用路径正确；</p>
                <p>2、修改ap.js，在文件里面找到：</p>
<pre><code class="javascript">// /common/ap.js
location.href='pay.htm?goto='</code></pre>
                <p>修改成：</p>
<pre><code class="javascript">// /common/ap.js
location.href='/pages/payment/alipay?goto='</code></pre>
                <h3>第二步，编辑你的pay.vue，引入ap.js</h3>
<pre><code class="javascript">// /pages/payment/pay.vue
// #ifdef H5
import ap from '@/common/ap.js'
// #endif</code></pre>
                <p>1、ap.js只支持H5，所以必须使用条件编译；</p>
                <p>2、然后，在pay.vue中选择支付宝支付时，向后台请求支付信息，返回后执行以下代码：</p>
<pre><code class="javascript">// /pages/payment/pay.vue
const payform = document.createElement('payform')
payform.innerHTML = res.data.paystring
document.body.appendChild(payform) // 注意，这三行代码跟demo不一样
let queryParam = ''
Array.prototype.slice.call(document.querySelectorAll("input[type=hidden]")).forEach(
    function(ele) {
        queryParam += ele.name + '=' + encodeURIComponent(ele.value) + '&'
    })
let gotoUrl = document.querySelector("#alipaysubmit").getAttribute('action') + '&' +
    queryParam
_AP.pay(gotoUrl)</code></pre>
                <h3>第三步，把pay.htm复制到/pages/payment/目录中，并重命名为alipay.vue，注意需要在pages.json中注册一下；</h3>
                <p>1、编辑alipay.vue文件，代码如下：</p>
                <p>2、模板</p>
<pre><code class="html">&lt;!--/pages/payment/alipay.vue--&gt;
&lt;template&gt;
    &lt;view class="container"&gt;
        &lt;view class="J-weixin-tip weixin-tip"&gt;
            &lt;view class="weixin-tip-content"&gt;
                请在菜单中选择在浏览器中打开,&lt;br /&gt;
                以完成支付
            &lt;/view&gt;
        &lt;/view&gt;
        &lt;view class="J-weixin-tip-img weixin-tip-img">&lt;/view&gt;
    &lt;/view&gt;
&lt;/template&gt;
&lt;!--注意我把demo原标签统一修改成适应uniapp的view标签--&gt;</code></pre>
                <p>3、JS</p>
<pre><code class="javascript">// /pages/payment/alipay.vue
import ap from '@/common/ap.js'
export default {
    data() {
        return {}
    },
    mounted() {
        if (location.hash.indexOf('error') != -1) {
            uni.showModal({
                content: '参数错误，请检查',
                showCancel: false
            })
        } else {
            var ua = navigator.userAgent.toLowerCase()
            var tip = document.querySelector(".weixin-tip")
            var tipImg = document.querySelector(".J-weixin-tip-img")
            if (ua.indexOf('micromessenger') != -1) {
                tip.style.display = 'block'
                tipImg.style.display = 'block'
                if (ua.indexOf('iphone') != -1 || ua.indexOf('ipad') != -1 || ua.indexOf('ipod') != -1) {
                    tipImg.className = 'J-weixin-tip-img weixin-tip-img iphone'
                } else {
                    tipImg.className = 'J-weixin-tip-img weixin-tip-img android'
                }
            } else {
                var getQueryString = function(url, name) {
                    var reg = new RegExp("(^|\\?|&)" + name + "=([^&]*)(\\s|&|$)", "i")
                    if (reg.test(url)) return RegExp.$2.replace(/\+/g, " ")
                }
                var param = getQueryString(location.href, 'goto') || ''
                location.href = param != '' ? _AP.decode(param) : 'http://xxx.com/pages/payment/alipay#error'
                // 此处的域名需改成你自己的域名
            }
        }
    }
}
</code></pre>
                <p>4、css中以.weixin开头的class需要保留，其它的都可以删除。</p>
                <h3>说明：</h3>
                <p>本文所有代码都是线上运营项目中拷贝出来的，如果直接复制使用，请确保严格按照上述指引修改，如果出现问题，请按如下步骤排查：</p>
                <p>1、一定要仔细看支付宝返回的错误提示！并根据指引进行相关排查；</p>
                <p>2、检查支付宝SDK版本是否最新，（之前遇到某个有问题的版本，更新到最新就正常了）；</p>
                <p>3、项目运行中是否有JS报错，如果有需先排除；</p>
                <p>4、ap.js和alipay.vue放置目录是否正确，且里面代码是否按上文正确修改；</p>
                <p>5、在pay.vue中需要自行判断平台类型以决定是否可选择支付宝支付。</p>
                <h3>文末总结</h3>
                <p>1、下载支付宝官方提供的微信中使用支付宝插件；</p>
                <p>2、ap.js复制到项目/common/目录中，并修改location.href路径；</p>
                <p>3、pay.htm复制到项目/pages/payment/目录中，重命名为alipay.vue，引入ap.js，并把域名修改为自己的域名；</p>
                <p>4、修改你的订单支付提交页/pages/payment/pay.vue，引入ap.js，选择支付宝支付后请求后台支付信息，然后跳转到/pages/payment/alipay.vue；</p>
                <p>5、支付后业务逻辑需自行处理（含支付成功和取消支付等）。</p>
            </div>
        </div>
    </div>
    <footer class="footer mt-3 bg-dark">
        <div class="container pt-3 pb-3 text-light text-center">Copyright &copy;王维 2022 254555778@qq.com</div>
    </footer>
</body>
</html>