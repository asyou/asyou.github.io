<!DOCTYPE html>
<html>
<head>
<title>PHP读取图片像素颜色，及图片转换成base64流方法 - 王维的博客</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="../favicon.ico" />
<link href="../bootstrap-5.1.3/css/bootstrap.min.css" rel="stylesheet">
<script src="../bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>
<link href="../highlight/styles/a11y-dark.min.css" rel="stylesheet">
<script src="../highlight/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>
<style type="text/css">
    body {
        margin-top: 70px;
    }
    h1 {
        font-size: 18px;
    }
    h3 {
        font-size: 16px;
    }
    p {
        font-size: 14px;
    }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">王维的博客</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item"><a class="nav-link" href="../index.html">主页</a></li>
					<li class="nav-item"><a class="nav-link active" href="../html/php.html">PHP</a></li>
					<li class="nav-item"><a class="nav-link" href="../html/vue.html">Vue</a></li>
					<li class="nav-item"><a class="nav-link" href="../html/unicloud.html">uniCloud</a></li>
					<li class="nav-item"><a class="nav-link" href="../html/notes.html">随手笔记</a></li>
				</ul>
			</div>
		</div>
	</nav>
    <div class="container">
        <div class="content mt-3">
            <h1>PHP读取图片像素颜色，及图片转换成base64流方法</h1>
            <span class="date"><small>2022-03-31</small></span>
            <div class="mt-4">
                <p>本篇文章代码来自网上搜集，主要目的是把图片转换成数据库可存储的方式，避免把图片存储在服务器上，这对于只有少量图片又不想存储图片的网站来说非常有用。</p>
                <p>所以本篇文章的研究内容是如何在不存储图片的情况下正常输出图片。</p>
                <p>常见的图片转换那必定是base64，主流浏览器都支持，推荐此方法。</p>
                <h3>一、图片转base64</h3>
<pre><code class="php">// /test.php
public function base64EncodeImage($image) {
  $base64_image = '';
  $image_info = getimagesize($image);
  $image_data = fread(fopen($image, 'r'), filesize($image));
  $base64_image = 'data:' . $image_info['mime'] . ';base64,' . base64_encode($image_data);
  return $base64_image;
}</code></pre>
                <p>使用方式就是，先把图片转换成base64文件流格式，可以保存在数据库中，也可以嵌入在css或js文件中，转换完后图片文件就可以删除了。</p>
                <h3>二、另辟蹊径</h3>
                <p>读取图片像素值保存入库，此方法纯属研究着玩儿，虽然也能用，但不建议实际使用。</p>
<pre><code class="php">// /test.php
public function getImageColors($image)
{
    $fileType = strrchr($image, '.');
    switch ($fileType) {
        case '.jpg':
        case '.jpeg':
            $ir = imagecreatefromjpeg($image);
            break;
        case '.png':
            $ir = imagecreatefrompng($image);
            // imagesavealpha($ir, true);
            break;
    }
    $rgb = [];
    list($width, $height) = getimagesize($image);
    for ($x=0; $x<$width; $x++){
        for ($y=0; $y<$height; $y++){
            $colors = imagecolorsforindex($ir, imagecolorat($ir, $x, $y));
            $rgb[$x][$y] = $this->rgb2hex($colors['red'],$colors['green'],$colors['blue']);
        }
    }
    // 保存入库
}

// RGB转HEX（16进制）
private function rgb2hex($r, $g=-1, $b=-1)
{
    if (is_array($r) && sizeof($r) == 3)
        list($r, $g, $b) = $r;
    $r = intval($r);
    $g = intval($g);
    $b = intval($b);
    $r = dechex($r < 0 ? 0 : ($r > 255 ? 255 : $r));
    $g = dechex($g < 0 ? 0 : ($g > 255 ? 255 : $g));
    $b = dechex($b < 0 ? 0 : ($b > 255 ? 255 : $b));
    $color  = (strlen($r) < 2 ? '0' : '').$r;
    $color .= (strlen($g) < 2 ? '0' : '').$g;
    $color .= (strlen($b) < 2 ? '0' : '').$b;
    if (($color[0] == $color[1]) && ($color[2]==$color[3]) && ($color[4]==$color[5])) {
        $color = $color[0].$color[2].$color[4];
    }
    return $color;
}</code></pre>
                <p>前端可以读取数据，并利用css/html将“图片”还原出来</p>
<pre><code class="php">// /test.php
public function drawImage($files)
{
    // $files 文件是上述方法转换成像素颜色的二维数组
    $html = '&lt;style>i {width:1px;height:1px;display:inline-block;}&lt;/style&gt;';
    for ($y=0; $y&lt;count($files); $y++) {
        for ($x=0; $x&lt;count($files[$y]); $x++) {
            $html.= '&lt;i style="background:#'.$files[$x][$y].'"&gt;&lt;/i&gt;';
        }
        $html.= '&lt;br&gt;';
    }
    echo $html;
}</code></pre>
                <p>原理就是把图片按x和y方向，按从左到右的顺序把所有像素对应的颜色读取出来，即每行一个数组，每行内的像素颜色一个子数组，最终即形成一个包含所有像素颜色的二维数组，接下来利用css/html特性“还原”图片。</p>
                <p>假设有一个图片长宽为3像素，每一行像素颜色为红、绿、蓝，则最终转换出来的数据格式输出如下：</p>
<pre><code class="php">// demo
Array
(
    [0] => Array
        (
            [0] => FF0000
            [1] => 008000
            [2] => 0000FF
        )

    [2] => Array
        (
            [0] => FF0000
            [1] => 008000
            [2] => 0000FF
        )

    [3] => Array
        (
            [0] => FF0000
            [1] => 008000
            [2] => 0000FF
        )

)
</code></pre>
                <p>通过serialize()方法序列化后得到的数据，图片越小数据体积越小，可见运用在小图片上并无太大问题。</p>
                <h3>三、说明</h3>
                <p>1、第一种方法是比较常用的方式，也是推荐的方式。base64方法转换后的图片比原图片体积大1/3左右，对于图片不大的情况下尚可接受；</p>
                <p>2、第二种方法比较另类，转换出来的数据比原图片大几倍到几十倍不等，也就是说1Mb的图片转换出来的数据体积可能达到10几Mb，对于网站来说明显不划算，但好处是由于前端是css/html模拟输出的图片，可以很好地防止盗图（当然防不了截图）；</p>
                <p>3、第一种方法虽然推荐使用，但也并不建议大量使用，因为大量使用会严重影响网页渲染速度（例如产品列表的缩略图），影响用户体验，适合于网站上固定的小图片使用；同样的，第二种方法也适合一些小图片的转换使用，例如3k、5k大小的图片，大图片转换由于体积太大不建议使用！</p>
                <p>4、图片文件最终都是以二进制方式存储在硬盘上，也就是说最终都是“数据”，由此思考，是否有一种方法可以用少量的字符或远少于图片体积的字符数据来表示一张完整的图片，并且图片之间的字符撞码率极低呢？就好比DNA，每个人的DNA都不一样，DNA数据体积对于人的体积来说完全可以忽略不计，但它却能完整描述出人的外貌、性别、身高等多元化特性，我相信肯定有这种算法，只是需要技术或科研人员去发掘。</p>
            </div>
        </div>
    </div>
    <footer class="footer mt-3 bg-dark">
        <div class="container pt-3 pb-3 text-light text-center">Copyright &copy;王维 2022 254555778@qq.com</div>
    </footer>
</body>
</html>