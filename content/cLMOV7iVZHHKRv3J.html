<!DOCTYPE html>
<html>
<head>
<title>PHP微信/支付宝退款流程及实现代码 - 王维的博客</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<link href="../highlight/styles/a11y-dark.min.css" rel="stylesheet">
<script src="../highlight/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>
<style type="text/css">
    body {
        margin-top: 70px;
    }
    h1 {
        font-size: 18px;
    }
    h3 {
        font-size: 16px;
    }
    p {
        font-size: 14px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    table tr th,table tr td {
        padding:  5px;
        border: 1px solid #eee;
    }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">王维的博客</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="../index.html">主页</a></li>
                    <li class="nav-item active"><a class="nav-link" href="../html/php.html">PHP</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/vue.html">Vue</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/unicloud.html">uniCloud</a></li>
                    <li class="nav-item"><a class="nav-link" href="../html/notes.html">随手笔记</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="content mt-3">
            <h1>PHP微信/支付宝退款流程及实现代码</h1>
            <span class="date"><small>2022-02-28</small></span>
            <div class="mt-4">
                <p>用户使用微信/支付宝下单后，难免会出现需要退款的情况。本文提供PHP代码实现微信/支付宝退款主要的代码。</p>
                <h3>本文要实现的功能及流程</h3>
                <p>1、用户在订单详情页点击退款按钮，订单变成退款审核状态；</p>
                <p>2、管理员在后台查看订单列表，对退款审核状态中的订单进行审核；</p>
                <p>3、审核通过则立即发起退款流程，支付金额将按原支付方式退回用户支付账户中；</p>
                <p>4、审核驳回则只把订单状态改为审核驳回状态，用户可以再次发起退款；</p>
                <p>5、确保订单表中有out_trade_no和trade_id字段，发起退款需要用到，这是微信或支付宝支付成功后会返回的参数；</p>
                <p>6、本文代码环境：ThinkPHP5.0，PHP版本7.4.x。</p>
                <br/>
                <h3>本示例使用到的微信/支付宝SDK如下</h3>
                <p>1、微信使用的是EasyWechat插件，版本号4.2.11，插件地址：<a href="https://www.easywechat.com/4.x/" target="_blank">点击前往</a></p>
                <p>2、支付宝使用的是Alipay EasySDK，版本号2.2.0，Github地址：<a href="https://github.com/alipay/alipay-easysdk/tree/master/php" target="_blank">点击前往</a></p>
                <p>3、注意：<b style="color: red;">涉及到用户退款，微信一定要有API证书文件！否则会失败！</b>API证书在商户后台申请后下载并部署到服务器上，然后在微信支付配置中引入。支付宝的话证书和非证书二选一，选证书的话跟微信一样去下载并部署，非证书的话使用支付宝公钥。支付宝公钥可使用支付宝提供的开放平台开发助手工具生成，本文使用的是此种方式。</p>
                <h3>上述SDK安装方式不尽相同，请先确保各自正确安装好</h3>
                <p>本文假设所有基础部署工作都已完成，SDK都可以正常使用。虽然本文给出的示例代码可以直接复制使用，但一定要先阅读并了解微信、支付宝官方的支付开发文档，遇到问题才不会手忙脚乱束手无策。</p>
                <p>回到正题，假设后端代码全部在Payment.php控制器</p>
                <h3>第一步，引入微信EasyWechat插件和支付宝EasySDK</h3>
<pre><code class="php">// /Payment.php
use think\Config;
use EasyWeChat\Factory;
use Alipay\EasySDK\Kernel\Factory as alipayFactory;
use Alipay\EasySDK\Kernel\Config as alipayConfig;</code></pre>
                <h3>第二步，微信和支付宝config.php配置</h3>
<pre><code class="php">// application/config.php
'wechat' => [
    'h5pay' => [
        'app_id' => '微信app_id',
        'mch_id' => '微信商户号',
        'key' => '微信支付密钥',
        'cert_path' => '证书目录/apiclient_cert.pem',
        'key_path' => '证书目录/apiclient_key.pem'
    ]
],
'alipay' => [
    'app_id' => '支付宝app_id',
    'private_key' => '支付宝私钥',
    'public_key' => '支付宝公钥'
],</code></pre>
                <h3>第三步，退款方法</h3>
<pre><code class="php">// Payment.php
/**
 * 退款方法
 * 该方法接收2个参数，一个订单类型，一个订单ID
 * @param string $type 订单类型:apply=预订订单,reserve=正式订单
 * @param integer $order_id 订单ID
 */
public function refund($type, $order_id)
{
    switch($type) {
        case 'apply':
            $order = $this->applyModel->field(['id','out_trade_no','trade_id','amount','pay_type'])->where(['id'=>$order_id])->find();
            switch($order['pay_type']) {
                case 'weixin.h5':   // 微信公众号支付
                case 'weixin.mp':   // 微信小程序支付
                case 'weixin.pc':   // 微信PC扫码支付
                case 'weixin.app':  // 微信app支付
                    $app = Factory::payment(Config::get('wechat.h5pay'));
                    $result = $app->refund->byTransactionId(
                        $order['trade_id'],     // 支付流水ID号
                        $order['id'],           // 订单ID号
                        $order['amount']*100,   // 退款总金额（单位是分）
                        $order['amount']*100,   // 退款金额（单位是分）
                        ['refund_desc' => '用户申请退款'] // 退款描述（可选）
                    );

                    switch($result['result_code']) {
                        case 'SUCCESS':
                            $rs = ['code'=>'1','msg'=>'退费成功','refund_id'=>$result['refund_id']];
                            break;
                        case 'FAIL':
                            $rs = ['code'=>'0','msg'=>$result['err_code_des']];
                            break;
                    }
                    return $rs;
                    break;
                case 'alipay.h5':   // 支付宝wap网页支付
                case 'alipay.pc':   // 支付宝PC扫码支付
                case 'alipay.app':  // 支付宝App支付
                    alipayFactory::setOptions($this->getOptions());
                    $result = alipayFactory::payment()->common()->refund(
                        $order['out_trade_no'], // 商户订单流水号
                        $order['amount']        // 退款金额
                    );
                    if ($result->code == '10000') {
                        $rs = ['code'=>'1','msg'=>'退费成功','refund_id'=>$result->tradeNo];
                    } else {
                        $rs = ['code'=>'0','msg'=>$result->subMsg];
                    }
                    return $rs;
                    break;
            }
            break;
        case 'reserve':
            break;
    }
}
// 注意：微信和支付宝接口返回的参数和结构都不一样，包括正常和错误的返回，这里微信返回拿到的是Array，而支付宝拿到的是Object，处理方式不同一定要注意；
// 微信和支付宝返回的参数中，退款成功的话都会返回流水ID，微信返回refund_id，支付宝返回tradeNo，一定要保存下来，因为后面可能需要用这个来查询退款状态。

/**
 * 获取支付宝支付参数
 */
private function getOptions()
{
    $options = new alipayConfig();
    $options->protocol = 'https';
    $options->gatewayHost = 'openapi.alipay.com';
    $options->signType = 'RSA2';
    
    $options->appId = Config::get('alipay.app_id');
    
    // 为避免私钥随源码泄露，推荐从文件中读取私钥字符串而不是写入源码中
    $options->merchantPrivateKey = Config::get('alipay.private_key');
    
    // $options->alipayCertPath = '<-- 请填写您的支付宝公钥证书文件路径，例如：/foo/alipayCertPublicKey_RSA2.crt -->';
    // $options->alipayRootCertPath = '<-- 请填写您的支付宝根证书文件路径，例如：/foo/alipayRootCert.crt" -->';
    // $options->merchantCertPath = '<-- 请填写您的应用公钥证书文件路径，例如：/foo/appCertPublicKey_2019051064521003.crt -->';
    
    // 注：如果采用非证书模式，则无需赋值上面的三个证书路径，改为赋值如下的支付宝公钥字符串即可
    $options->alipayPublicKey = Config::get('alipay.public_key');

    // 可设置异步通知接收服务地址（可选）
    $options->notifyUrl = "";　// 若需要通知，则填写通知URL
    
    // 可设置AES密钥，调用AES加解密相关接口时需要（可选）
    // $options->encryptKey = "<-- 请填写您的AES密钥，例如：aa4BtZ4tspm2wnXLb1ThQA== -->";
    return $options;
}</code></pre>
                <h3>说明：</h3>
                <p>上述refund方法并非在后台模块中，实际需要在后台订单管理控制器中跨模块调用，使用方法如下</p>
<pre><code class="php">// 后台方法，假设上面的Payment.php控制器在API模块中：
$rs = controller('api/payment')->refund('apply',$order_id);</code></pre>
                <p>上述getOptions方法同样也适用于支付宝支付参数配置，可自行拓展以适应支付和退款时不同的通知方式。</p>
                <h3>吐个槽～</h3>
                <p>微信公众号支付需要在商户后台配置支付授权目录且有数量限制（这点难以理解，产品业务线长的话需要各种跳转支付影响体验）；</p>
                <p>微信公众号用户授权方式是需要跳转到微信服务器获取code，再跳转回来用code去换取用户信息，这种方式且不说体验不好，如果是vue开发的单页应用经这么一跳，定义的关键变量就直接给跳没了，必须用缓存的方式保存起来，技术这么发达的年代，api接口静默授权很难么？</p>
                <p>微信公众号授权跟微信小程序授权返回的用户数据结构<b style="color: red;">并不统一</b>，需要在后端逐一判断并统一保存，这真是个巨坑！！！另外似乎目前网页授权经常抽疯不返回昵称和头像，只能得到个openid，这对需要用户信息的场景比如生成推广海报来说是个巨大的灾难；</p>
                <p>不管是微信还是支付宝，官方提供的开发者文档真是烂到极致，尤其是对新手极其不友好，完全不知道从何下手。</p>
            </div>
        </div>
    </div>
    <footer class="footer mt-3 bg-dark">
        <div class="container pt-3 pb-3 text-light text-center">Copyright &copy;王维 2022 254555778@qq.com</div>
    </footer>
</body>
</html>